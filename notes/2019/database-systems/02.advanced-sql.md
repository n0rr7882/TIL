# Advanced SQL

## Relational Languages

사용자는 어떻게 실행하는 방법을 원하는 것이 아닌 특정한 결과값을 원한다.

DBMS 는 쿼리를 책임지고 효율적으로 평가할 수 있다.

* Query optimizer: Operation 들을 재배열시키고 Query plan 을 생성한다.

SQL 은 기술적으로 하나가 아닌 여러개의 언어 모음이다.

* Data Manipulation Language (DML)
* Data Difination Language (DDL)
* Data Control Language (DCL)

그리고 다음 내용도 포함된다.

* View difination
* Integrity & Referential Constraints
* Transactions

**SQL 은 `sets`(no duplicates) 이 아닌 `bags`(duplicates) 에 기초한다.**

## History of SQL

* SQL 의 원조격인 `SEQUEL` 은 IBM 의 System R 프로토타입에서 처음 등장하였다.
    * **S**tructured **E**nglish **Q**uery **L**anguage
    * Oracle 이 1970년에 채택하였다.
* IBM 이 1983년 `DB2` 를 공개하였다.
* 1986년 ANSI 표준이 지정되고, 1987년 ISO 표준이 지정되었다.
    * **S**tructured **Q**uery **L**anguage

현재의 표준은 `SQL:2016`이다.
* `SQL:2016`: JSON, Polymorphic Table 지원
* `SQL:2011`: Temporal DB, Pipelined DML 지원
* `SQL:2008`: TRUNCATE, Fancy ORDER 지원
* `SQL:2003`: XML, Windows, Sequences, Auto-generated ID 지원
* `SQL:1999`: Regex, Triggers, OO

대부분의 DBMS 들은 최소한 `SQL-92` 를 지원한다.

## Aggregates

Tuple 의 집합에서 Single value 를 반환하는 함수들이다.
* `AVG(col)`: col 값의 평균을 반환한다.
* `MIN(col)`: col 값의 최소값을 반환한다.
* `MAX(col)`: col 값의 최대값을 반환한다.
* `SUM(col)`: col 값의 총합을 반환한다.
* `COUNT(col)`: col 값의 개수를 반환한다.

* Aggregate 함수들은 SELECT 의 output 리스트에서만 사용할 수 있다.
* `COUNT`, `SUM`, `AVG` 는 `DISTINCT` 를 지원한다.
* 집계되지 않은 Column 은 undefined 이다.

```sql
SELECT AVG(s.gpa), e.cid        -- e.cid is undefined
FROM enrolled AS e, student AS s
WHERE e.sid = s.sid
```

## Group by

* Tuple 을 서브셋으로 구성하며 각 서브셋에 대한 집계를 계산힌다.
* `SELECT` 절의 집계되지 않은 값들은 `GROUP BY` 절에 존재해야 한다.

```sql
SELECT AVG(s.gpa), e.cid, s.name
FROM enrolled AS e, student AS s
WHERE e.sid = s.sid
GROUP BY e.cid, s.name  -- SELECT 절의 e.cid, s.name 서브셋을 맞춘다.
```

## Having

* Aggregation 계산을 기반으로 결과를 필터링한다.
* `GROUP BY`의 `WHERE` 절과 같다.

```sql
SELECT AVG(s.gpa) AS avg_gpa, e.cid
FROM enrolled AS e, student AS s
WHERE e.sid = s.sid -- AND avg_gpa > 3.9
GROUP BY e.cid
HAVING avg_gpa > 3.9 -- after aggregates
```

## String Operations

DBMSs | String Case | String Quotes
------|-------------|--------------
SQL-92 | Sensitive | Single Only
Postgres | Sensitive | Single Only
MySQL | Insensitive | Single/Double
SQLite | Sensitive | Single/Double
DB2 | Sensitive | Single Only
Oracle | Sensitive | Single Only

* `LIKE`
    * 문자열 탐색을 위해 사용된다.
    * String-matching operators
        * `'%'`: 부분 문자열(빈 문자열 포함)을 찾는다.
        * `'_'`: 문자 하나를 찾는다.
    * Ex)
        ```sql
        SELECT * FROM enrolled AS e WHERE e.cid LIKE '15-%';
        SELECT * FROM student AS s WHERE s.login LIKE '%@c_';
        ```

* `SUBSTRING`, `LOWER, UPPER` 등
    * SQL-92 에는 여러 String functions 이 정이되어 있다.
        * 많은 DBMS들 또한 각자의 동일한 역할을 수행하는 함수를 가지고 있다.
    * 각각의 Output 들과 기술(predicates) 마다 사용될 수 있다.
    * Ex)
        ```sql
        SELECT SUBSTRING(name, 0, 5) AS abbrv_name FROM student WHERE sid = 53688;
        SELECT * FROM student AS s WHERE UPPER(e.name) LIKE 'KAN%';
        ```

* `CONCAT`
    * SQL 표준에서 `||` 연산자는 두개 이상의 문자열을 이을 수 있다.
    * Ex)
        ```sql
        SELECT name FROM student WHERE login = LOWER(name) || '@cs'; -- SQL-92
        SELECT name FROM student WHERE login = LOWER(name) + '@cs'; -- MSSQL
        SELECT name FROM student WHERE login = CONCAT(LOWER(name), '@cs') -- MySQL
        ```

