# Buffer Pools

## Database Storage

### Spetial Control

* 디스크의 어디에 페이지를 Write 해야 하는가
* 목표는 함께 자주 사용되는 페이지를 가능한 한 디스크에 물리적으로 가깝게 유지하는 것

### Temporal Control

* 언제 페이지를 메모리로 Read 해야 하며, 언제 페이지를 디스크로 Write 해야 하는가
* 목표는 디스크에서 데이터를 Read 하면서 발생하는 스톨(데이터베이스 I/O 작업 단위) 수를 줄이는 것

## Disk-Oriented DBMS

### Buffer Pool 이란?

* 디스크에 있는 파일에서 읽어들이는 Page 를 데이터베이스 시스템이 담을 수 있는 In Memory Cache 이다.
* OS 입장에서 Page 를 단순하게 파일처럼 Read / Write 할 뿐, 쿼리가 어떻게 페이지를 접근하는지에 대해 이해하지 않는다. 즉, 모든 페이지를 동일하게 취급한다.
    * 몇몇 페이지는 인덱스 정보를 담고 있고 몇몇 페이지는 Immutable 데이터를 담고 있지만 OS 는 그것을 알지 못한다.
    * 따라서, Database Buffer Pool 의 Data I/O 는 DBMS 가 관리하게 된다.

## Buffer Pool Organization

메모리 구역은 fixed-size 페이지의 배열 형태로 구성되어 있다.
배열의 Entry 는 프레임(frame) 이라고 부른다.

DBMS 가 페이지를 요청하면, 파일과 동일한 페이지의 사본이 프레임에 올라간다.

현재 메모리에 올라가 있는 페이지들을 추적하는 **페이지 테이블(Page table)** 이 있다.
페이지 ID 를 가지고 프레임을 추적하는 해쉬맵이라고 생각할 수 있다.

페이지 테이블은 페이지 당 Meta-data 를 포함한다.
* Dirty flag
* Pin/Reference Counter

현대 시스템은 많은 CPU 코어를 가지고 있어서, 다중 쓰레드 작업에서 다중으로 쿼리가 동시에 이 페이지 테이블로 접근을 시도할 수 있다. 만약 첫번째 쓰레드가 페이지 테이블에 올라가 있는 페이지의 내용을 Buffer Pool 에 Fetch 함과 동시에 다른 쓰레드가 같은 페이지 테이블 위에 다른 페이지 구성으로 Replace 한다면 Buffer Pool 프레임은 다른 페이지 내용으로 바뀌게 된다. 따라서 페이지 테이블에서는 **Pin/Reference Counter 을 지원하여 현재 페이지 테이블을 사용중인 실행중인 쿼리 개수를 카운팅** 한다.

## Locks VS. Latches

### Locks:

* 다른 트랜잭션으로부터 데이터베이스의 내용을 논리적으로 보호한다.
* 트랜잭션 기간동안 잡는다.
* Rollback Change 가 가능해야 한다.

### Latches:

* DBMS 의 내부 데이터 구조에서의 중요한 처리를 다른 쓰레드로부터 보호한다.
* 연산 기간동안 잡는다(Mutex).
* Rollback Change 가 필요 없다.

## Page Table VS. Page Directory

Page Directory 는 데이터베이스 파일에 페이지로서 존재하며 Page ID 와 Page Location 을 맵핑해준다.
* 모든 변경사항은 DBMS 가 재시작 시 찾을 수 있도록 기록되어야 한다.

Page Table 은 Page ID 와 Buffer Pool 프레임에 올라가 있는 페이지의 복사본을 맵핑해준다.
* 디스크에 저장될 필요가 없는 In-memory data structure 이다.
