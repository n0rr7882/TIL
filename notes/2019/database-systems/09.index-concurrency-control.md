# Index Concurrency Control

## Observation

싱글 쓰레드에서 지금까지 봐온 자료구들이 어떻게 동작하는지에 대해서는 이미 알고있다.

하지만 자료구조는 추가적인 멀티 CPU 코어 구조가 가지는 장점을 사용하면서도 멀티 쓰레드 상에서 동작해야 한다.

## Concurrency Control

동시성 제어(Concurrency Control) 프로토콜이란 DBMS 가 자원을 공유하는 동시 작업으로부터 "올바른" 결과를 내놓는 것을 보장하도록 하는 메소드이다.

프로토콜의 정확성 기준은 다음과 같은 카테고리를 가진다.
* Logical Correctness: 가정한(기대한) 데이터를 볼 수 있는가
* Physical Correctness: 어떠한 개체가 디스크의 공간에 유효하게 저장되는 것에 대한 내부 표현인가(그 프로토콜을 사용함으로써 디스크 내부의 해당 데이터 접근이 가능한가?)

## Locks VS. Latches

* Locks:
    * 다른 트랜잭션으로부터 인덱스의 논리적 내용을 보호한다.
    * 트랜잭션 기간동안 잡는다.
    * Rollback Change 가 가능해야 한다.
* Latches:
    * 다른 쓰레드로부터 인덱스의 내부 데이터 구조에 대한 크리티컬한 부분을 보호한다.
    * 연산 기간동안 잡는다(Mutex).
    * Rollback Change 가 필요 없다.

-           | Locks                       | Latches
------------|-----------------------------|------------------------
보호의 기준    | 사용자의 트랜잭션               | 쓰레드
보호 대상     | 데이터베이스 콘텐츠              | In-memory 데이터 구조
보호 기간     | 트랜잭션 기간동안                | Critical Sections
모드         | Shared, Exclusive, Update, Intention | Read, Write
Deadlock    | 탐지 & 해결                   | Avoidance
Deadlock 발생원인 | Waits-for, 타임아웃, 중단   | 설계 및 구현상 오류
Kept in...  | Lock Manager                | Protected Data Structure

## Latch Modes

### Read Mode

* 다중 쓰레드에게 같은 시점에 같은 아이템을 읽는 것을 허용한다.
* 다른 쓰레드가 read mode 로 아이템을 사용하고 있어도 read latch 를 얻을 수 있다.

## Write Mode

* 오직 하나의 쓰레드만 하나의 아이템에 대해 허용된다.
* 다른 쓰레드가 모드에 관계 없이 latch 를 잡고 있다면 write latch 를 얻을 수 없다.
